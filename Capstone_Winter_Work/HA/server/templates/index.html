{% include 'header.html' %}

<div class="wrapper">

	<nav id="sidebar" class="bg-primary">
		<div class="sidebar-header bg-secondary">
			<h3>EPIC</h3>
		</div>
			
		<ul class="list-unstyled component">
			<li>
				<a href="/">
					<i class="fas fa-home"></i>
					Home
				</a>
			</li>
			<li>
				<a href="#packageSubmenu" data-toggle="collapse" aria-expanded="false" class="dropdown-toggle">
					<i class="fas fa-box"></i>
					Packages
				</a>
				<ul class="collapse list-unstyled" id="packageSubmenu">
					<li>
						<a href="/packages">View Packages</a>
					</li>
					<li>
						<a href="/packages/add">Add Package</a>
					</li>
					<hr>
					<p>Packages</p>
					{% for package in packages %}
					<li>
						{% for name in package %}
						<a href="/packages/{{ name }}">{{ name }}</a>
						{%endfor%}
					</li>
					{% endfor %}
					<hr>
				</ul>
			</li>
			<li>
				<a href="#deviceSubmenu" data-toggle="collapse" aria-expanded="false" class="dropdown-toggle">
					<i class="fas fa-laptop"></i>
					Devices
				</a>
				<ul class="collapse list-unstyled" id="deviceSubmenu">
					<li>
						<a href="/devices">View Devices</a>
					</li>
					<hr>
					<p>Connected Devices</p>
					{% if devices %}
						{% for device in devices %}
					<li>
						<a href="/devices/{{ device['internal_id'] }}">{{ device['moz_definition']['name'] }}</a>
					</li>
						{% endfor %}
					{% else %}
					<li>
						<span>No Device Connected</span>
					</li>
					{% endif %}
					<hr>
				</ul>
			</li>
			<li>
				<a href="#macroSubmenu" data-toggle="collapse" aria-expanded="false" class="dropdown-toggle">
					<i class="fas fa-tasks"></i>
					Macros
				</a>
				<ul class="collapse list-unstyled" id="macroSubmenu">
					<li>
						<a href="/macros">View Macros</a>
					</li>
					<li>
						<a href="/macros/add">Add Macro</a>
					</li>
					<hr>
					<p>Current Macros</p>
					{% if macros %}
					<li>
						<!-- TODO -->
					</li>
					{% else %}
					<li>
						<span>No Macros Found</span>
					</li>
					{% endif %}
					<hr>
				</ul>
			</li>
		</ul>
	</nav>

	<div class="content dashboard" style="width: 100%">
		<nav class="navbar navbar-expand-lg navbar-light bg-light">
			<div class="container-fluid">

				<button type="button" id="sidebarCollapse" class="btn btn-primary">
					<i class="fas fa-align-left"></i>
					<span>Toggle Sidebar</span>
				</button>
				
				<div class="form-group row w-50 mb-0">
					<input type="text" class="ml-auto w-50 form-control" placeholder="Search..." id="search-bar" />
				</div>
			
			</div><!-- .container-fluid -->
		</nav><!-- .navbar -->

		<div class="container-fluid">
			<div class="masonry">
				<!-- Create Package Cards -->
				{% for package in packages %}
					{% for name in package %}
				<div class="card">
					<div class="card-header bg-success text-light">
						{{ name }}
					</div><!-- .card-header -->
					<div class="container-fluid"><div class="row">
						<div class="col-lg-3 px-0">
							<div class="nav flex-column nav-pills tabs-packages" id="tabs-package-{{ package[name]['package_id'] }}" role="tablist" aria-orientation="vertical">
								<a class="nav-item nav-link rounded-0 active" id="p-info-tab-{{ package[name]['package_id'] }}" data-toggle="tab" href="#p-info-{{ package[name]['package_id'] }}" role="tab" aria-controls="p-info-{{ package[name]['package_id'] }}" aria-selected="true">Meta</a>
								<a class="nav-item nav-link rounded-0" id="p-cmd-tab-{{ package[name]['package_id'] }}" data-toggle="tab" href="#p-cmd-{{ package[name]['package_id'] }}" role="tab" aria-controls="p-cmd-{{ package[name]['package_id'] }}" aria-selected="true">Commands</a>
								<a class="nav-item nav-link rounded-0" id="p-app-tab-{{ package[name]['package_id'] }}" data-toggle="tab" href="#p-app-{{ package[name]['package_id'] }}" role="tab" aria-controls="p-app-{{ package[name]['package_id'] }}" aria-selected="true">Applications</a>
								<a class="nav-item nav-link rounded-0" id="p-binding-tab-{{ package[name]['package_id'] }}" data-toggle="tab" href="#p-binding-{{ package[name]['package_id'] }}" role="tab" aria-controls="p-binding-{{ package[name]['package_id'] }}" aria-selected="true">Bindings</a>
							</div>
						</div>
						<div class="col-lg-9">
							<div class="tab-content" id="tabContent-package-{{package[name]['package_id'] }}">
								<div class="tab-pane card-body fade show active" id="p-info-{{ package[name]['package_id'] }}" role="tabpanel" aria-labelledby="p-info-tab-{{ package[name]['package_id'] }}">
									<ul>
										<li>Creator: {{ package[name]['meta']['creator'] }}</li>
										<li>Last Modified: {{ package[name]['meta']['last modified'] }}</li>
										<li>Description: {{ package[name]['meta']['description'] }}</li>
									</ul>
								</div>
								<div class="tab-pane card-body fade" id="p-cmd-{{ package[name]['package_id'] }}" role="tabpanel" aria-labelledby="p-cmd-tab-{{ package[name]['package_id'] }}">
									<ul>
									{% for command in package[name]['commands'] %}
										<li>{{ command }}</li>
									{% endfor %}
									</ul>
								</div>
								<div class="tab-pane card-body fade" id="p-app-{{ package[name]['package_id'] }}" role="tabpanel" aria-labelledby="p-app-tab-{{ package[name]['package_id'] }}">
									<ul>
									{% for application in package[name]['applications'] %}
										<li>{{ application }}</li>
									{% endfor %}
									</ul>
								</div>
								<div class="tab-pane card-body fade" id="p-binding-{{ package[name]['package_id'] }}" role="tabpanel" aria-labelledby="p-binding-tab-{{ package[name]['package_id'] }}">
									<ul>
									{% for binding in package[name]['bindings'] %}
										<li>{{ binding }}</li>
									{% endfor %}
									</ul>
								</div>
							</div>
						</div>
					</div></div><!-- .card-body -->
				</div><!-- .card -->
					{% endfor %}
				{% endfor %}
				<!-- Create Device Cards -->
				{% for device in devices %}
				<div class="card">
					<div class="card-header bg-warning text-light">
						{{ device['moz_definition']['name']|title }}	
					</div>
					<div class="container-fluid"><div class="row">
						<div class="col-lg-3 px-0">
							<div class="nav flex-column nav-pills tabs-devices" id="tabs-device-{{ device['internal_id'] }}" role="tablist">
								<a class="nav-item nav-link rounded-0 active" id="d-info-tab-{{ device['internal_id'] }}" data-toggle="tab" href="#d-info-{{ device['internal_id'] }}" role="tab" aria-controls="d-info-{{ device['internal_id'] }}" aria-selected="true">Info</a>
								<a class="nav-item nav-link rounded-0" id="d-property-tab-{{ device['internal_id'] }}" data-toggle="tab" href="#d-property-{{ device['internal_id'] }}" role="tab" aria-controls="d-property-{{ device['internal_id'] }}" aria-selected="true">Properties</a>
								<a class="nav-item nav-link rounded-0" id="d-action-tab-{{ device['internal_id'] }}" data-toggle="tab" href="#d-action-{{ device['internal_id'] }}" role="tab" aria-controls="d-action-{{ device['internal_id'] }}" aria-selected="true">Actions</a>
							</div><!-- .nav-pills -->
						</div><!-- .col-lg-3 -->
						<div class="col-lg-9">
							<div class="tab-content" id="tabContent-device-{{ device['internal_id'] }}">
								<div class="tab-pane card-body fade show active" id="d-info-{{ device['internal_id'] }}" role="tabpanel" aria-labelledby="d-info-tab-{{ device['internal_id'] }}">
									<span>Internal UUID: {{ device['internal_id'] }}</span><br>
									<span>Manager ID: {{ device['manager_id'] }}</span><br>
									<span>Description: {{ device['moz_definition']['description'] }}</span><br>
								</div><!-- #info-tab -->
								<div class="tab-pane card-body fade" id="d-property-{{ device['internal_id'] }}" role="tabpanel" aria-labelledby="d-property-tab--{{ device['internal_id'] }}">
								{% for property in device['moz_definition']['properties'] %}
									<span>{{ property|title }}: {{ device['moz_definition']['properties'][property]['description'] }}</span><br>
									<div class="container-fluid">
										<div class="form-group form-row">
											<input type="text" class="col-7 form-control read-value-display" readonly value="--"/>
											<button type="button" class="col-4 offset-1 btn btn-warning text-light submit-read" data-target="{{ device["internal_id"] }}" data-property="{{ property }}">Read</button>
										</div>
										{% if device['moz_definition']['properties'][property]['readOnly'] == False %}
										<div class="form-group form-row">
											<input type="text" class="col-7 form-control" />
											<button type="button" class="col-4 offset-1 btn btn-warning text-light">Write</button>
										</div>
										{% endif %}
									</div>
								{% endfor %}
								</div><!-- #property-tab -->
								<div class="tab-pane card-body fade" id="d-action-{{ device['internal_id'] }}" role="tabpanel" aria-labelledby="d-action-tab-{{ device['internal_id'] }}">
								{% for action in device['moz_definition']['actions'] %}
									<div class="container-fluid">
										<div class="form-group form-row">
											<input type="text" class="col-7 form-control" readonly value="{{ action }}">
											<button type="button" class="col-4 offset-1 btn btn-warning text-light">Trigger</button>
										</div>
									</div>
								{% endfor %}
								</div>
							</div><!-- .tab-content -->
						</div><!-- .col-lg-9 -->
					</div></div><!-- .card-body -->
				</div><!-- .card -->
				{% endfor %}
			</div><!-- .masonry -->
		</div><!-- .container-fluid -->

	</div><!-- .dashboard -->

<style>
@import "https://fonts.googleapis.com/css?family=Lato:300,400,500,600,700";

body {
	font-family: 'Lato', sans-serif;
	background: #DCDCDC;
}

p {
	font-family: 'Lato', sans-serif;
	font-size: 1.1em;
	font-weight: 300;
	line-height: 1.7em;
	color: #BBB;
}

a, a:hover, a:focus {
	color: inherit;
	text-decoration: none;
	transition: all 0.3s;
}

.wrapper {
	display: flex;
	width: 100%;
	align-items: stretch;
}

.sidebar-header {
	height: 54px;
	text-align: center;
	background-color: #003366;
}
.sidebar-header h3 {
	line-height: 54px;
}

#sidebar {
	min-width: 250px;
	max-width: 250px;
	min-height: 100vh;

	color: #fff;
	transition: all 0.3.s;
}
#sidebar hr {
	border-color: #BBB;
}
#sidebar .siderbar-header {
	padding: 20px;
	background: #6D7FCC;
}
#sidebar ul.components {
	padding: 20px 0;
	border-bottom: 1px solid #47748B;
}
#sidebar ul p {
	color: #FFF;
	padding: 10px;
}
#sidebar.active ul p {
	font-size: 0.85em;
}
#sidebar ul li a,
#sidebar ul li span {
	padding: 10px;
	font-size: 1.1em;
	display: block;
}

/* Additions */
#sidebar.active ul li a {
	padding: 20px 10px;
	text-align: center;
	font-size: 0.85em;
}
#sidebar.active ul li a i {
	margin-right: 0;
	display: block;
	font-size: 1.8em;
	margin-bottom: 5px;
}
#sidebar.active ul ul a {
	padding: 10px !important;
}
#sidebar.active ul ul li a,
#sidebar.active ul ul li span {
	font-size: 0.65em !important;
}
/* .Additions */

#sidebar ul li a:hover {
	color: #7386D5;
	background #FFF;
}
#sidebar ul li.active > a, a[aria-expanded="true"] {
	color: #FFF;
}
#sidebar.active {
	min-width: 80px;
	max-width: 80px;
	text-align: center;
}
ul ul a,
ul ul span {
	font-size: 0.9em !important;
	padding-left: 30px !important;
}
a[data-toggle="collapse"] {
	position: relative;
}
.dropdown-toggle::after {
	display: block;
	position: absolute;
	top: 50%;
	right: 20px;
	transform: translateY(-50%);
}
#sidebar.active .dropdown-toggle::after {
	top: auto;
	bottom: 10px;
	right: 50%;
	-webkit-transform: translateX(50%);
	-ms-transform: translateX(50%);
	transform: translateX(50%);
}
@media (max-width: 268px) {
	#sidebar {
		margin-left: -250px; 
	}
	#sidebar.active {
		margin-left: 0;
	}
}

.navbar {
	margin-bottom: 1em;
}

.masonry {
	column-count: 3;
	column-gap: 1em;
}
@media (max-width: 768px) {
	.masonry {
		column-count: 1;
	}
}
@media (max-width: 1200px) {
	.masonry {
		column-count: 2;
	}
}

.card {
	display: inline-block;
	margin: 0 0 1em;
	width: 100%;
}

.tabs-packages .nav-link.active {
	background: #45B85E!important;
}
.tabs-devices .nav-link.active {
	background: #FFCE3D!important;
}
</style>

<script>
$(document).ready(function() {

	$(".action-trigger").click(function() {

		var target = $(this).data("target");
		var action = $(this).data("action");

		data = {"target": target, "action": action}

		$.ajax({
			method: "POST",
			url: "/devices/action/trigger",
			data: data,
			success: function(data) {
				alert("Triggered "+action+" for "+target+": "+data);
			}
		})

	});

	$(".submit-read").click(function() {

		var button = $(this);
		var target = $(this).data('target');
		var property = $(this).data('property');

		data = {"target": target, "property": property}

		$.ajax({
			method: "POST",
			url: "/devices/property/read",
			data: {
				"target": target,
				"property": property,
			},
			success: function(data) {
				console.log(data);
				response = JSON.parse(data);
				console.log(response["value"]);
				var now = new Date()
				var time = now.getHours() + ":" + now.getMinutes() + ":" + now.getSeconds()
				button.siblings('.read-value-display').val(response["value"]+" ("+time+")");
			}
		})

	});

	$(".submit-write").click(function() {

		var target = $(this).data('target');
		var property = $(this).data('property');
		var value = $('input[name="'+$(this).data('input')+'"]').val();

		data = {"target": target, "property": property, "value": value}

		$.ajax({
			method: "POST",
			url: "/devices/property/write",
			success: function(data) {
				alert("Wrote "+property+" of "+target+" to "+value+": "+data)
			}
		})

	});

	$('#sidebarCollapse').click(function() {
		$('#sidebar').toggleClass('active');
	});
	
	$('#search-bar').keyup(function() {

		var search = $(this).val();

		$('.card-header').each(function() {
			console.log($(this).html());
			console.log(search)
			if( $(this).html().toLowerCase().includes(search.trim().toLowerCase()) ) {
				$(this).parent().show();
			} else {
				$(this).parent().hide();
			}
		});
	});

});
</script>

</body>

</html>

